<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>‚öΩ Soccer AI Coach</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0; height: 100vh; display: flex; flex-direction: column;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: #f3f5f8;
    }
  
    
    .bubble a {
      color: #1e90ff;
      text-decoration: none;
      font-weight: 600;
    }
    .bubble a:hover {
      text-decoration: underline;
    }
    header {
      background: linear-gradient(90deg,#1e90ff,#00c6ff);
      color:#fff; padding:14px 18px; font-weight:700; letter-spacing:.3px;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
    }
    .container { max-width: 960px; margin: 0 auto; width: 100%; flex: 1; display: flex; flex-direction: column; }
    #profile {
      background:#fff; margin:16px; padding:12px; border-radius:14px; box-shadow:0 2px 6px rgba(0,0,0,.06);
      display:flex; flex-wrap:wrap; gap:10px;
    }
    #profile input {
      flex:1 1 150px; min-width: 140px; padding:10px; border:1px solid #d9dee5; border-radius:10px;
    }
    #profile button {
      padding:10px 14px; border:none; border-radius:10px; background:#1e90ff; color:#fff; cursor:pointer; font-weight:600;
    }
    #profile button:hover { filter:brightness(.95); }

    #chat-card {
      flex:1; display:flex; flex-direction:column; margin:0 16px 16px; background:#fff; border-radius:14px; box-shadow:0 2px 6px rgba(0,0,0,.06);
      overflow:hidden;
    }
    #messages {
      flex:1; overflow-y:auto; padding:16px; background: #f8fafc;
      display:flex; flex-direction:column; gap:10px;
    }
    .bubble {
      max-width: 76%; padding:10px 14px; border-radius:16px; line-height:1.45; font-size:15px;
      box-shadow:0 2px 4px rgba(0,0,0,.08); animation: fadeIn .25s ease;
      white-space:pre-wrap;
    }
    .me { align-self:flex-end; background:#1e90ff; color:#fff; border-bottom-right-radius:6px; }
    .ai { align-self:flex-start; background:#e9eef5; color:#111827; border-bottom-left-radius:6px; }
    .typing { opacity:.7; font-style:italic; }
    #composer { display:flex; gap:8px; padding:10px; border-top:1px solid #e6e9ef; background:#fff; }
    #composer input {
      flex:1; padding:12px; border:1px solid #d9dee5; border-radius:12px; outline:none; font-size:15px;
    }
    #composer button {
      padding:12px 16px; border:none; border-radius:12px; background:#1e90ff; color:#fff; font-weight:700; cursor:pointer;
    }
    #composer button:disabled { opacity:.6; cursor:not-allowed; }
    @keyframes fadeIn { from {opacity:0; transform: translateY(8px);} to {opacity:1; transform:none;} }
  </style>
</head>
<body>
  <header>‚öΩ Soccer AI Coach</header>

  <div class="container">
    <!-- Profile -->
    <section id="profile">
      <input id="name" placeholder="Name" />
      <input id="age" type="number" placeholder="Age" />
      <input id="weight" type="number" placeholder="Weight (kg)" />
      <input id="height" type="number" placeholder="Height (cm)" />
      <input id="strengths" placeholder="Strengths" />
      <input id="weaknesses" placeholder="Weaknesses" />
      <input id="expertise" placeholder="Expertise level" />
      <input id="time" type="number" placeholder="Free time (mins/day)" />
      <button id="saveBtn">üíæ Save Profile</button>
    </section>

    <!-- Chat -->
    <section id="chat-card">
      <div id="messages"></div>
      <form id="composer">
        <input id="query" placeholder="Ask your coach..." autocomplete="off" required />
        <button id="sendBtn" type="submit">Send</button>
        <button id="clearHistoryBtn" style="margin:10px; padding:8px 12px; border:none; border-radius:8px; background:#ff4d4f; color:#fff; cursor:pointer;">
          üóëÔ∏è Clear History
      </button>
      </form>
    </section>
  </div>

  <script>
    const BASE_URL = "http://127.0.0.1:8000"; // change if your backend runs elsewhere
    const messagesEl = document.getElementById("messages");
    const queryEl = document.getElementById("query");
    const sendBtn = document.getElementById("sendBtn");
    const saveBtn = document.getElementById("saveBtn");

    window.addEventListener("DOMContentLoaded", async () => {
    
    const token = localStorage.getItem("jwt");
    if (!token) {
      alert("‚ö†Ô∏è You are not logged in!");
      window.location.href = "login.html";
    }
    
    saveBtn.addEventListener("click", async () => {
      const profile = {
        name: document.getElementById("name").value,
        age: parseInt(document.getElementById("age").value) || null,
        weight: parseFloat(document.getElementById("weight").value) || null,
        height: parseFloat(document.getElementById("height").value) || null,
        strengths: document.getElementById("strengths").value,
        weaknesses: document.getElementById("weaknesses").value,
        expertise: document.getElementById("expertise").value,
        time: parseInt(document.getElementById("time").value) || null,
      };

      try {
        const res = await fetch(`${BASE_URL}/v1/user/profile`, {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify(profile)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || "Failed to save profile");
        alert("‚úÖ Profile saved!");
      } catch (e) {
        alert("‚ö†Ô∏è " + e.message);
      }
    });

    async function loadProfile() {
      try {
        const res = await fetch(`${BASE_URL}/v1/user/profile`, {
          headers: { "Authorization": `Bearer ${token}`},
        });
        
        const profile = await res.json();
        if (Object.keys(profile).length > 0) {
          document.getElementById("name").value = profile.name || "";
          document.getElementById("age").value = profile.age || "";
          document.getElementById("weight").value = profile.weight || "";
          document.getElementById("height").value = profile.height || "";
          document.getElementById("strengths").value = profile.strengths || "";
          document.getElementById("weaknesses").value = profile.weaknesses || "";
          document.getElementById("expertise").value = profile.expertise || "";
          document.getElementById("time").value = profile.time || "";
        }
      } catch (err) {
      console.error("Could not load profile:", err);
      }
    }
    loadProfile()

    try {
      const res = await fetch(`${BASE_URL}/v1/chat/history`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const data = await res.json();

      if (Array.isArray(data)) {
        data.forEach(msg => {
          addBubble(msg.content, msg.role === "assistant" ? "ai" : "me");
        });
      }
    } catch (err) {
      console.error("Failed to load chat history:", err);
    }
  });
    const clearHistoryBtn = document.getElementById("clearHistoryBtn");

    clearHistoryBtn.addEventListener("click", async () => {
    const token = localStorage.getItem("jwt");
      if (!token) {
      alert("‚ö†Ô∏è You are not logged in!");
      return;
    }
    async function loadProfile() {
      try {
        const res = await fetch(`${BASE_URL}/v1/user/profile`, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await res.json();
        if (Object.keys(data).length > 0) {
          document.getElementById("name").value = data.name || "";
          document.getElementById("age").value = data.age || "";
          document.getElementById("weight").value = data.weight || "";
          document.getElementById("height").value = data.height || "";
          document.getElementById("strengths").value = data.strengths || "";
          document.getElementById("weaknesses").value = data.weaknesses || "";
          document.getElementById("expertise").value = data.expertise || "";
          document.getElementById("time").value = data.time || "";
        }
      } catch (err) {
        console.error("Could not load profile:", err);
      }
    }

    loadProfile();
    if (!confirm("Are you sure you want to clear your chat history?")) return;

    try {
      const res = await fetch(`${BASE_URL}/v1/chat/history`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${token}` }
      });
      const data = await res.json();

      if (res.ok) {
        messagesEl.innerHTML = ""; // clear messages from UI
        alert("‚úÖ Chat history cleared!");
        } else {
        alert("‚ö†Ô∏è Failed to clear history: " + (data.detail || "Unknown error"));
      }
    } catch (err) {
    console.error(err);
    alert("‚ö†Ô∏è Network error");
    }
  });

  // ---------- Your existing functions ----------
  function addBubble(text, cls = "ai") {
    const div = document.createElement("div");
    div.className = `bubble ${cls}`;
    div.innerHTML = marked.parse(text);
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    return div;
  }

  function addTyping() {
    return addBubble("Coach is typing‚Ä¶", "ai typing");
  }
    // Helpers
    function addBubble(text, cls = "ai") {
      const div = document.createElement("div");
      div.className = `bubble ${cls}`;
      div.innerHTML = marked.parse(text);
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      return div;
    }
    function addTyping() {
      return addBubble("Coach is typing‚Ä¶", "ai typing");
    }
    function removeEl(el) { if (el && el.parentNode) el.parentNode.removeChild(el); }

    // Save Profile

    // Send query
    document.getElementById("composer").addEventListener("submit", async (e) => {
      e.preventDefault();
      const q = (queryEl.value || "").trim();
      if (!q) return;
      addBubble(q, "me");
      queryEl.value = "";
      queryEl.focus();

      sendBtn.disabled = true;
      const typing = addTyping();

      try {
        const token = localStorage.getItem("jwt"); // get JWT from login
        if (!token) {
          alert("‚ö†Ô∏è Please login first");
          sendBtn.disabled = false;
          return;
        }

        const res = await fetch(`${BASE_URL}/v1/coach`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}` // <-- Add JWT here
        },
        body: JSON.stringify({ query: q }),
      });
        const data = await res.json().catch(() => ({}));

        removeEl(typing);
        // ‚úÖ Your FastAPI returns {"answer": "..."} ‚Äî use data.answer
        if (res.ok && data && typeof data.answer === "string") {
          addBubble(data.answer, "ai");
        } else if (!res.ok) {
          addBubble(`‚ö†Ô∏è Server error (${res.status}): ${data?.detail || "Unknown error"}`, "ai");
        } else {
          addBubble("(No answer field returned by server)", "ai");
        }
      } catch (err) {
        removeEl(typing);
        addBubble("‚ö†Ô∏è Network error. Is the backend at 127.0.0.1:8000 running?", "ai");
        console.error(err);
      } finally {
        sendBtn.disabled = false;
      }
    });

    // number parsing helpers
    function toInt(v){ const n=parseInt(v,10); return Number.isFinite(n)?n:null; }
    function toFloat(v){ const n=parseFloat(v); return Number.isFinite(n)?n:null; }
  </script>
</body>
</html>
